define(["jquery","jqueryui"],function(a){var b=function(b){this.debug=b,this.elem=a("div#datepicker"),this.bookings=[],this.log("Creating object");var c=new Date,d=this;this.elem.datepicker({dateFormat:"yy-mm-dd",changeMonth:!1,changeYear:!1,gotoCurrent:!0,firstDay:1,minDate:c,numberOfMonths:[1,1],altField:"#date",showOtherMonths:!0,selectOtherMonths:!0,beforeShowDay:function(b){var c=a.datepicker.formatDate("yy-mm-dd",b);if(d.bookings.hasOwnProperty(c)){var e=d.bookings[c].join("&#013;");return d.log("Marking "+c),[!0,"highlight-day",e]}return a(this).removeClass("highlight-day"),[!0,"",""]}})};return b.prototype.log=function(a){this.debug&&console.log("[DATEPICKER] "+a)},b.prototype.get=function(){return this.elem.val()},b.prototype.get_today=function(){return a(".ui-datepicker-today")},b.prototype.set_today=function(){this.get_today().click()},b.prototype.get_real_day=function(){var a=new Date,b=a.getFullYear(),c=a.getMonth();++c<10?c="0"+c:c;var d=a.getDate();return d<10?d="0"+d:d,b+"-"+c+"-"+d},b.prototype.set_bookings_by_date=function(a){if(null==a||0==a.length)return!1;for(var b,c,d,e,f=0;f<a.length;f++)b=a[f],c=b.day,d=b.time,e=b.labname,this.add_booking(c,d,e)},b.prototype.mark_booked=function(b){var c=this;c.log("Marking booked"),this.elem.datepicker("option","beforeShowDay",function(d){var e=a.datepicker.formatDate("yy-mm-dd",d);return b.hasOwnProperty(e)?(c.log("Marking "+e),[!0,"highlight-day",b[e]]):[!0,"",""]})},b.prototype.update_marked_bookings=function(){var b=this;b.log("Marking booked"),this.elem.datepicker("option","beforeShowDay",function(c){var d=a.datepicker.formatDate("yy-mm-dd",c);if(b.bookings.hasOwnProperty(d)){var e=b.bookings[d].join("&#013;");return b.log("Marking "+d),[!0,"highlight-day",e]}return[!0,"",""]})},b.prototype.add_booking=function(a,b,c){var d=this;null==d.bookings[a]&&(d.bookings[a]=[]),d.bookings[a].push(b+" "+c)},b.prototype.delete_booking=function(a,b){var c=this;if(c.bookings[a]){for(var d=-1,e=0;e<c.bookings[a].length;e++)if(item=c.bookings[a][e],item.substr(0,5)==b){d=e;break}d>=0&&c.bookings[a].splice(d,1),0==c.bookings[a].length&&delete c.bookings[a]}},b.prototype.refresh=function(){var a=this;a.elem.datepicker("refresh")},b.prototype.update_picker=function(b,c,d,e){d.data="undefined"!=typeof d.data?d.data:d,b.log("select "+c+" <EVENT>");var f=d.data.timepicker;f.set_today(b.get_real_day()==c),f.is_today()?(f.disable_past_hours(),f.next_free_hour(),f.is_interval_picker_init()&&f.is_current_hour_select()?(f.disable_past_interv(),f.next_free_interv(e)):f.clear_past_interv()):f.clear_past();var g=d.data.urlbase+"/get_booked_slots.php?id="+d.data.course_id+"&labid="+d.data.lab_id+"&date="+c;a.getJSON(g,function(a){b.log("GET "+g),0==a["busy-slots"].length?(f.clear_busy_interv(),b.log("No busy slots this day")):f.is_interval_picker_init()&&(f.set_busy(a["busy-slots"]),f.disable_busy_interv(),f.next_free_interv(e))})},b.prototype.on_date_change_setup=function(b){var c=this;this.elem.on("change",b,function(b){c.update_picker(c,a(this).val(),b,!0)})},b.prototype.update=function(a){var b=this;b.update_picker(b,b.get(),a,!1)},b});