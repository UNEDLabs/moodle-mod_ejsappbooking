define(["jquery","jqueryui"],function(a){var b=function(b){this.debug=b,this.elem=a("div#datepicker"),this.bookings=[],this.log("Creating object");var c=new Date,d=this;this.elem.datepicker({dateFormat:"yy-mm-dd",changeMonth:!1,changeYear:!1,gotoCurrent:!0,firstDay:1,minDate:c,numberOfMonths:[1,1],altField:"#date",showOtherMonths:!0,selectOtherMonths:!0,beforeShowDay:function(b){var c=a.datepicker.formatDate("yy-mm-dd",b);if(d.bookings.hasOwnProperty(c)){var e=d.bookings[c].join("&#013;");return d.log("Marking "+c),[!0,"highlight-day",e]}return a(this).removeClass("highlight-day"),[!0,"",""]}})};return b.prototype.log=function(a){this.debug&&console.log("[DATEPICKER] "+a)},b.prototype.get=function(){return this.elem.val()},b.prototype.get_today=function(){return a(".ui-datepicker-today")},b.prototype.set_today=function(){this.get_today().click()},b.prototype.get_real_day=function(){var a=new Date,b=a.getFullYear(),c=a.getMonth();++c<10?c="0"+c:c;var d=a.getDate();return d<10?d="0"+d:d,b+"-"+c+"-"+d},b.prototype.set_bookings_by_date=function(a){if(null==a||0==a.length)return!1;for(var b,c,d,e,f=0;f<a.length;f++)b=a[f],c=b.day,d=b.time,e=b.labname,this.add_booking(c,d,e)},b.prototype.mark_booked=function(b){var c=this;c.log("Marking booked"),this.elem.datepicker("option","beforeShowDay",function(d){var e=a.datepicker.formatDate("yy-mm-dd",d);return b.hasOwnProperty(e)?(c.log("Marking "+e),[!0,"highlight-day",b[e]]):[!0,"",""]})},b.prototype.update_marked_bookings=function(){var b=this;b.log("Marking booked"),this.elem.datepicker("option","beforeShowDay",function(c){var d=a.datepicker.formatDate("yy-mm-dd",c);if(b.bookings.hasOwnProperty(d)){var e=b.bookings[d].join("&#013;");return b.log("Marking "+d),[!0,"highlight-day",e]}return[!0,"",""]})},b.prototype.add_booking=function(a,b,c){var d=this;null==d.bookings[a]&&(d.bookings[a]=[]),d.bookings[a].push(b+" "+c)},b.prototype.delete_booking=function(a,b){var c=this;if(c.bookings[a]){for(var d=-1,e=0;e<c.bookings[a].length;e++)if(item=c.bookings[a][e],item.substr(0,5)==b){d=e;break}d>=0&&c.bookings[a].splice(d,1),0==c.bookings[a].length&&delete c.bookings[a]}},b.prototype.refresh=function(){var a=this;a.elem.datepicker("refresh")},b.prototype.on_date_change_setup=function(b){var c=this;this.elem.on("change",b,function(b){c.log("select "+a(this).val()+" <EVENT>");var d=b.data.timepicker;d.set_today(c.get_real_day()==a(this).val()),d.is_today()?(d.disable_past_hours(),d.next_free_hour(),d.is_interval_picker_init()&&d.is_current_hour_select()?(d.disable_past_interv(),d.next_free_interv()):d.clear_past_interv()):d.clear_past();var e=b.data.urlbase+"/get_booked_slots.php?id="+b.data.course_id+"&labid="+b.data.lab_id+"&date="+a(this).val();d.clear_busy_interv(),a.getJSON(e,function(a){c.log("GET "+e),0==a["busy-slots"].length?c.log("No busy slots this day"):d.is_interval_picker_init()&&(d.set_busy(a["busy-slots"]),d.disable_busy_interv(),d.next_free_interv())})})},b});